@page "/product/{id:int}"
@using Application.Catalog.Shared
@rendermode InteractiveServer
@using Application.Catalog.GetProductById;
@inject IDialogService DialogService

@if (_product == null)
{
    <MudProgressCircular Color="Color.Primary" />
}
else
{
    <MudPaper>
        <MudGrid Spacing="4" Justify="Justify.SpaceEvenly">
            <MudItem md="12">
                <MudText Typo="Typo.h1" Class="ml-4">@_product.Name</MudText>
            </MudItem>

            <MudItem md="12" lg="5">
                <div class="d-flex justify-center">
                    <img class="rounded-lg"
                         style="max-width: 100%; max-height: 500px; object-fit: cover;"
                         src="@_product.Photo"
                         alt="Product"
                         onerror="this.onerror=null;this.src='@DefaultImageUrl';" />
                </div>
            </MudItem>

            <MudItem md="12" lg="4">
                <MudSimpleTable Style="overflow-x: auto;" Hover="true" Bordered="true">
                    <tbody>
                    <tr>
                        <td>Артикул</td>
                        <td>@_product.Id</td>
                    </tr>
                    <tr>
                        <td>Наявність</td>
                        <td>
                            @if (_product.Stock >= 3) { <MudText Color="Color.Primary">в наявності</MudText> }
                            else if (_product.Stock < 3 && _product.ProductTypeId == 1) { <MudText Color="Color.Error">під замовлення</MudText> }
                            else { <MudText Color="Color.Warning">в дорозі</MudText> }
                        </td>
                    </tr>
                    @if (_product.QuantityInPack > 0)
                    {
                        <tr>
                            <td>Кіл-ть в упаковці</td>
                            <td>@_product.QuantityInPack</td>
                        </tr>
                    }
                    <tr>
                        <td>Ціна</td>
                        <td>@_product.GetPriceForType(_priceType) грн</td>
                    </tr>
                    </tbody>
                </MudSimpleTable>
                <MudButton Class="flex-grow-1 mud-width-full-sm mt-4"
                           OnClick="@((e) => OpenСontactDialogAsync(_product.Id, _product.Name))"
                           Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.ShoppingCartCheckout">
                    Швидке замовлення
                </MudButton>
            </MudItem>

        </MudGrid>
    </MudPaper>

    <MudPaper >
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <MudTabPanel Text="Схема" Icon="@Icons.Material.Filled.Lan">
                <div class="d-flex justify-center">
                    <img src="@_product.Scheme"
                         style="max-height: 750px; object-fit: cover;"
                         onerror="this.style.display='none'"
                         class="scheme-img" />
                </div>
            </MudTabPanel>
        </MudTabs>
    </MudPaper>

}

@code {
    [Parameter] public int Id { get; set; }
    private ProductDto? _product;
    string _priceType = "price_10";
    const string DefaultImageUrl = "https://cdn.jsdelivr.net/gh/inboxmakc-coder/kedr-images/furniture/00000000.jpg";

    protected override async Task OnInitializedAsync()
    {
        var query = new GetProductByIdQuery(Id);
        _product = await Mediator.Send(query);
    }

    private Task OpenСontactDialogAsync(int id, string name)
    {
        string order = $"🆔({id.ToString()}) — 🧾{name}";

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };
        var parameters = new DialogParameters<СontactDialog>
        {
            { x => x.Model, new QuickOrderVm(message: order)}
        };

        return DialogService.ShowAsync<СontactDialog>("Simple Dialog", parameters, options);
    }
}
