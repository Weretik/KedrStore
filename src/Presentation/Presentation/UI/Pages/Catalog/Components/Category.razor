@using Application.Catalog.GetCategories
@inject ISnackbar Snackbar
@inject ICatalogStore CatalogStore

<MudPaper Class="pa-4 mb-4">
    <MudText Typo="Typo.h4" class="mt-5 mb-3 ml-5">
        Категорії
    </MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Size="Size.Medium" Indeterminate="true" />
    }
    else
    {
        <MudTreeView T="CategoryTreeDto"
                     Items="@_items"
                     SelectedValue="@_selected"
                     SelectedValueChanged="OnSelectedChanged"
                     Hover="true"
                     Dense="true"
                     ExpandOnClick="true">
            <ItemTemplate>
                <MudTreeViewItem Value="@context.Value"
                                 Text="@context.Text"
                                 Items="@context.Children" />
            </ItemTemplate>
        </MudTreeView>
    }

</MudPaper>

@code {
    private IReadOnlyCollection<TreeItemData<CategoryTreeDto>> _items = [];
    private CategoryTreeDto? _selected;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Mediator.Send(new GetCategoriesQuery());
            if (!result.IsSuccess || result.Value is null) return;

            _items = result.Value.ToTreeItems();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnSelectedChanged(CategoryTreeDto? node)
    {
        if (node?.Children is { Count: > 0 })
        {
            _selected = null;

            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
            Snackbar.Add("Виберіть кінцеву категорію.", Severity.Info,
                configure => configure.SnackbarVariant = Variant.Outlined);
            return;
        }

        _selected = node;
        CatalogStore.SetCategory(node?.Id);

    }

}
