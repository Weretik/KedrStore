@rendermode InteractiveServer
@using Application.Catalog.CreateQuickOrder
@using Application.Catalog.CreateQuickOrder.Contracts
@using Application.Catalog.CreateQuickOrder.DTOs
@using FluentValidation
@inject IValidator<IQuickOrder> Validator

<MudDialog>

    <TitleContent>
        <MudText Typo="Typo.h2">Залиште свої дані</MudText>
        <MudText Typo="Typo.subtitle1">Вкажіть ваше ім’я та телефон. Менеджер зв’яжеться з вами протягом 15 хвилин.</MudText>
    </TitleContent>

    <DialogContent>
        <MudForm Model="@Model" @ref="@_form" Validation="@(Validator.ValidateValue(Model))" ValidationDelay="0">

            <MudTextField @bind-Value="Model.Name"
                          For="()=>Model.Name"
                          InputType="InputType.Text"
                          Placeholder="Андрій"
                          DebounceInterval="500"
                          Variant="Variant.Outlined"
                          Counter="25"
                          MaxLength="25"
                          Label="Ім'я"
                          Required="true"/>

            <MudTextField @bind-Value="Model.Phone"
                          For="()=>Model.Phone"
                          InputType="InputType.Telephone"
                          Mask="@(new PatternMask("00 000 00 00"))"
                          Placeholder="99 123 45 67"
                          Adornment="Adornment.Start"
                          AdornmentText="(+380)"
                          MaxLength="9"
                          DebounceInterval="500"
                          Variant="Variant.Outlined"
                          Label="Телефон"
                          Required="true"/>

            <MudTextField @bind-Value="Model.Message"
                          For="()=>Model.Message"
                          Variant="Variant.Outlined"
                          Lines="3"
                          DebounceInterval="500"
                          Counter="500"
                          MaxLength="500"
                          Label="Повідомлення"/>

        </MudForm>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel">Скасувати</MudButton>
        <MudButton OnClick="SubmitAsync" Color="Color.Primary"  Variant="Variant.Filled" >Відправити</MudButton>
    </DialogActions>

</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public QuickOrderVm Model { get; set; } = new();

    private MudForm _form = null!;

    private void Cancel() => MudDialog.Cancel();
    private async Task SubmitAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new QuickOrderRequest(Model!.Name, Model.Phone, Model.Message);
            var command = new CreateQuickOrderCommand(request);
            await Mediator.Send(command);

            MudDialog.Close(DialogResult.Ok(true));
        }
    }
}


